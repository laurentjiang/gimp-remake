name: Release Installer

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  release-installer:
    name: Create Windows Installer
    runs-on: windows-latest
    # Only run when CI succeeds AND was triggered by a tag (not main branch pushes)
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Get tag name
        id: tag
        shell: pwsh
        run: |
          $tag = "${{ github.event.workflow_run.head_branch }}"
          echo "name=$tag" >> $env:GITHUB_OUTPUT

      - name: Download CI Artifact
        uses: actions/download-artifact@v4
        with:
          name: gimp-remake-windows-${{ github.event.workflow_run.head_sha }}
          path: release-files
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Setup NSIS
        run: choco install nsis -y

      - name: Collect Qt/Runtime DLLs
        shell: pwsh
        run: |
          # Copy Qt deployment tool output
          New-Item -ItemType Directory -Force -Path installer/bin
          Copy-Item -Path release-files/* -Destination installer/bin -Recurse -Force

      - name: Create NSIS Installer Script
        shell: pwsh
        run: |
          $version = "${{ steps.tag.outputs.name }}".TrimStart('v')
          $script = @"
          !include "MUI2.nsh"
          
          Name "Gimp Remake $version"
          OutFile "GimpRemake-${{ steps.tag.outputs.name }}-windows-x64-installer.exe"
          InstallDir "`$PROGRAMFILES64\GimpRemake"
          RequestExecutionLevel admin
          
          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH
          
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          
          !insertmacro MUI_LANGUAGE "English"
          
          Section "Install"
            SetOutPath "`$INSTDIR"
            File /r "installer\bin\*.*"
            
            ; Create uninstaller
            WriteUninstaller "`$INSTDIR\uninstall.exe"
            
            ; Start menu shortcuts
            CreateDirectory "`$SMPROGRAMS\Gimp Remake"
            CreateShortcut "`$SMPROGRAMS\Gimp Remake\Gimp Remake.lnk" "`$INSTDIR\gimp-remake.exe"
            CreateShortcut "`$SMPROGRAMS\Gimp Remake\Uninstall.lnk" "`$INSTDIR\uninstall.exe"
            
            ; Desktop shortcut
            CreateShortcut "`$DESKTOP\Gimp Remake.lnk" "`$INSTDIR\gimp-remake.exe"
            
            ; Registry entries for Add/Remove Programs
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\GimpRemake" "DisplayName" "Gimp Remake"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\GimpRemake" "UninstallString" "`$INSTDIR\uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\GimpRemake" "DisplayVersion" "$version"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\GimpRemake" "Publisher" "Gimp Remake Team"
          SectionEnd
          
          Section "Uninstall"
            RMDir /r "`$INSTDIR"
            RMDir /r "`$SMPROGRAMS\Gimp Remake"
            Delete "`$DESKTOP\Gimp Remake.lnk"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\GimpRemake"
          SectionEnd
          "@
          $script | Out-File -FilePath installer.nsi -Encoding UTF8

      - name: Build NSIS Installer
        run: makensis installer.nsi

      - name: Upload Installer to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.name }}
          files: GimpRemake-${{ steps.tag.outputs.name }}-windows-x64-installer.exe
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
