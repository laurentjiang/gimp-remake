name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  pull-requests: write

env:
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json,readwrite"
  VCPKG_COMMIT: 'cc73782a88db48af17f8bfb8328d4cab3d4c246f'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOBS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Windows Build, Lint & Test
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  build-windows:
    name: Build, Lint & Test (Windows)
    runs-on: windows-latest
    timeout-minutes: 240
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@v1.1
        with:
          version: 1.11.1

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1.13.0

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
          doNotCache: true
          runVcpkgInstall: false

      - name: Install OpenCppCoverage
        run: choco install opencppcoverage -y

      - name: Install NSIS (for releases)
        if: startsWith(github.ref, 'refs/tags/v')
        run: choco install nsis -y

      - name: Configure NuGet for GitHub Packages
        shell: pwsh
        run: |
          $nuget = & "${{ github.workspace }}/vcpkg/vcpkg" fetch nuget | Select-Object -Last 1
          & $nuget sources add -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" -StorePasswordInClearText -Name "GitHubPackages" -UserName "${{ github.repository_owner }}" -Password "${{ secrets.GITHUB_TOKEN }}" -NonInteractive
          & $nuget setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" -NonInteractive

      - name: Check formatting
        shell: pwsh
        run: |
          Write-Host "Using clang-format: $(clang-format --version)"
          $sources = git ls-files '*.cpp' '*.h' '*.hpp'
          $failed = $false
          foreach ($file in $sources) {
            if (Test-Path $file) {
              $output = & clang-format --dry-run --Werror $file 2>&1
              if ($LASTEXITCODE -ne 0) {
                Write-Host "::error file=$file::Formatting issues found"
                $output | ForEach-Object { Write-Host $_ }
                $failed = $true
              }
            }
          }
          if ($failed) {
            Write-Host "::error::Format check failed. Run './scripts/run-format.ps1' locally."
            exit 1
          }
          Write-Host "âœ“ Formatting check passed" -ForegroundColor Green

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=RelWithDebInfo `
            -DVCPKG_TARGET_TRIPLET=x64-windows-release `
            -DVCPKG_OVERLAY_TRIPLETS="${{ github.workspace }}/triplets" `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        shell: pwsh
        run: .\scripts\run-lint.ps1

      - name: Build
        run: cmake --build build --config RelWithDebInfo --parallel

      - name: Run Tests
        run: ctest --test-dir build --output-on-failure --verbose

      - name: Run Tests with Coverage
        id: coverage
        shell: pwsh
        continue-on-error: true
        run: |
          $env:PATH = "C:\Program Files\OpenCppCoverage;$env:PATH"
          
          # Run tests with coverage collection
          OpenCppCoverage --sources "${{ github.workspace }}\src" `
            --sources "${{ github.workspace }}\include" `
            --modules "${{ github.workspace }}\build" `
            --excluded_sources "${{ github.workspace }}\tests" `
            --excluded_sources "${{ github.workspace }}\build\_deps" `
            --excluded_sources "${{ github.workspace }}\build\vcpkg_installed" `
            --export_type cobertura:build\coverage.xml `
            --optimized_build `
            -- .\build\unit_tests.exe
          
          # Parse coverage from cobertura XML
          if (Test-Path "build\coverage.xml") {
            [xml]$cov = Get-Content "build\coverage.xml"
            $lineRate = [math]::Round([double]$cov.coverage.'line-rate' * 100, 1)
            $branchRate = [math]::Round([double]$cov.coverage.'branch-rate' * 100, 1)
            echo "line_coverage=$lineRate%" >> $env:GITHUB_OUTPUT
            echo "branch_coverage=$branchRate%" >> $env:GITHUB_OUTPUT
          } else {
            echo "line_coverage=N/A" >> $env:GITHUB_OUTPUT
            echo "branch_coverage=N/A" >> $env:GITHUB_OUTPUT
          }

      - name: Collect Redistributable Files
        shell: pwsh
        run: |
          # Create distribution folder
          New-Item -ItemType Directory -Force -Path dist
          
          # Copy main executable
          Copy-Item build/gimp-remake.exe dist/
          
          # Copy Qt plugins
          Copy-Item -Path build/platforms -Destination dist/ -Recurse -Force
          if (Test-Path build/iconengines) { Copy-Item -Path build/iconengines -Destination dist/ -Recurse -Force }
          if (Test-Path build/imageformats) { Copy-Item -Path build/imageformats -Destination dist/ -Recurse -Force }
          if (Test-Path build/styles) { Copy-Item -Path build/styles -Destination dist/ -Recurse -Force }
          
          # Copy all DLLs from vcpkg (Qt, Skia, etc.)
          Get-ChildItem -Path build/vcpkg_installed/x64-windows*/bin/*.dll -ErrorAction SilentlyContinue | ForEach-Object {
            Copy-Item $_.FullName dist/ -Force
          }
          
          # List what we're packaging
          Write-Host "Distribution contents:"
          Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }

      - name: Create Windows Installer
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          cd build
          cpack -G NSIS -C RelWithDebInfo
          # List generated installers
          Get-ChildItem -Filter "*.exe" | ForEach-Object { Write-Host "Installer: $($_.Name)" }

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gimp-remake-windows-${{ github.sha }}
          path: dist/
          retention-days: 14

      - name: Upload Installer Artifact
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: gimp-remake-installer-${{ github.sha }}
          path: build/GimpRemake-*.exe
          retention-days: 14

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-windows
          path: build/Testing/
          retention-days: 7

    outputs:
      line_coverage: ${{ steps.coverage.outputs.line_coverage }}
      branch_coverage: ${{ steps.coverage.outputs.branch_coverage }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Release (Only on tags)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: gimp-remake-windows-${{ github.sha }}
          path: release/windows

      - name: Download Installer Artifact
        uses: actions/download-artifact@v4
        with:
          name: gimp-remake-installer-${{ github.sha }}
          path: release/installer

      - name: Create Release Package
        run: |
          cd release/windows
          zip -r ../../gimp-remake-${{ github.ref_name }}-windows-x64.zip .
          cd ../..
          # Rename installer with version
          mv release/installer/GimpRemake-*.exe gimp-remake-${{ github.ref_name }}-windows-x64-installer.exe

      - name: Generate Changelog
        id: changelog
        run: |
          echo "## Changes in ${{ github.ref_name }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.md 2>/dev/null || echo "- Initial release" >> CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG.md
          files: |
            gimp-remake-${{ github.ref_name }}-windows-x64.zip
            gimp-remake-${{ github.ref_name }}-windows-x64-installer.exe
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CI Status Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: always()
    
    steps:
      - name: Check CI Status
        run: |
          if [ "${{ needs.build-windows.result }}" == "failure" ]; then
            echo "::error::CI pipeline failed"
            exit 1
          fi
          echo "All CI checks passed"

      - name: Post PR Summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-summary
          message: |
            ## ğŸ” CI Summary
            
            | Check | Status |
            |-------|--------|
            | **Format & Lint** | ${{ needs.build-windows.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | **Build (Windows)** | ${{ needs.build-windows.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | **Tests** | ${{ needs.build-windows.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            
            ### ğŸ“Š Coverage (OpenCppCoverage)
            | Metric | Value |
            |--------|-------|
            | Line Coverage | ${{ needs.build-windows.outputs.line_coverage || 'N/A' }} |
            | Branch Coverage | ${{ needs.build-windows.outputs.branch_coverage || 'N/A' }} |
            
            ---
            <sub>Generated by CI â€¢ Commit: ${{ github.sha }}</sub>
